
[[clause-datastreams]]
== Requirements Class "Datastreams & Observations"

=== Overview
include::../requirements/datastream/requirements_class_datastreams.adoc[]

The "Datastreams & Observations" requirements class specifies how `DataStream` and `Observation` resources are provided using the CS API.

A `DataStream` resource represents data produced by a single output of an (observation) system (itself represented by a `System` feature in the CS API). The `DataStream` can be used to provide access to real-time data only, archived data only, or both. The metadata in the `DataStream` description can be used to disambiguate between these cases.

`DataStream` and `Observation` resources implement the _http://www.w3.org/ns/sosa/ObservationCollection[ObservationCollection]_ and _http://www.w3.org/ns/sosa/Observation[Observation]_ concepts defined in the {ogc-w3c-ssn}, respectively.



[[clause-datastream-resource]]
=== DataStream Resource

==== Introduction

In the CS API Standard, `DataStream` resources are a special kind of resource that implements the _http://www.w3.org/ns/sosa/ObservationCollection[sosa:ObservationCollection]_ concept, with the following restrictions:

- All observations in a `DataStream` are produced by the same `System`; and
- All observations in a `DataStream` share the same observed properties and the same result schema.

This section defines the attributes and associations composing a `DataStream` resource, but the exact way they are encoded in the payload is defined by each encoding. For encodings defined in this document, please see:

- <<clause-json-datastream,DataStream resource encoded in JSON>>

Below is the contextual class diagram of the `DataStream` resource:

[#datastream-class,reftext='{figure-caption} {counter:figure-num}']
.DataStream Resource Diagram
image::figures/FIG002-datastream-class.png[api-class-diagram, align="center"]

==== Properties

The following tables describe the attributes and associations of a `DataStream` resource and their mapping to SOSA/SSN.

[#datastream-attributes,reftext='{table-caption} {counter:table-num}']
.DataStream Attributes
[width="100%",options="header"]
|====
| *Name*               | *SOSA/SSN Property* | *Definition* | *Data Type* | *Usage*
| `name`               | `rdfs:label` | The human readable name of the datastream. | String | Mandatory
| `description`        | `rdfs:comment` | A human readable description for the datastream. | String | Optional
| `type`               | - | The type of datastream (see <<datastream-types>>). | Enum | Optional
| `validTime`          | `sosa:validTime` | The validity period of the datastream's description. | TimeExtent | Optional
| `phenomenonTime`     | `sosa:phenomenonTime` | The time period spanned by the phenomenon times of all observations in the datastream. | TimeExtent | Required
| `resultTime`         | `sosa:resultTime` | The time period spanned by the result times of all observations in the datastream. | TimeExtent | Required
| `observedProperties` | `sosa:observedProperty` | Properties for which the observations in the datastream provide measurements. | List<URI> | Required
| `resultType`         | - | The type of result for observations in the datastream (see <<result-types>>). | Enum | Required
| `live`               | - | Indicates whether live data is available from the datastream. | Boolean | Required
| `formats`            | - | The list of formats that the observations in the datastream can be encoded to. | List<String> | Required
|====

The values for the properties `observedProperties`, `phenomenonTime`, `resultTime`, `resultType` SHALL be automatically generated by the server based the `Observations` that are linked to the `Datastream`. If there are no linked Observations the properties SHALL be set to `null`.
The property `live` MAY be generated by the server. In this case the server MAY ignore updates to the property.

[#datastream-types,reftext='{table-caption} {counter:table-num}']
.DataStream Types
[width="100%",options="header"]
|====
| *Datastream Type*   | *Usage*
| `status`            | For datastreams providing status observations of the parent system itself or one of its subsystems.
| `observation`       | For datastreams providing observations of other features of interest (not the system itself).
|====

[#result-types,reftext='{table-caption} {counter:table-num}']
.Result Types
[width="100%",options="header"]
|====
| *Result Type*    | *Usage*
| `measure`        | When the result is a single scalar value with a unit of measure 
| `vector`         | When the result is a vector quantity (e.g velocity vector, stress tensor)
| `record`         | When the result is a record containing only scalar values and/or vectors
| `coverage`       | When the result is a coverage (any number of dimensions)
| `complex`        | When the result is a record with nested records and/or arrays
|====

[#datastream-assocs,reftext='{table-caption} {counter:table-num}']
.DataStream Associations
[width="100%",options="header"]
|====
| *Name*               | *SOSA/SSN Property* | *Definition* | *Target Content* | *Usage*
| `system`             | `sosa:isObservedBy` | The `System` that is the producer of the datastream. | A single `System` resource (by reference). | Required
| `observations`       | `sosa:hasMember` | The `Observations` that are part of the datastream. | A list of `Observation` resources. | Required
| `procedure` | `sosa:usedProcedure` | The procedure used to generate observations in the datastream. | A single `Procedure` resource. | Optional
| `deployment` | - | The deployment during which the datastream was generated. | A single `Deployment` resource. | Optional
| `samplingFeatures`   | `sosa:hasFeatureOfInterest` | The `Sampling Features` that are the subject of observations in the datastream. | A list of `SamplingFeature` resources. | Optional
| `featuresOfInterest` | `sosa:hasUltimateFeatureOfInterest` | The ultimate features of interest that are the subject of observations in the datastream. | A list of `Feature` resources. | Optional
|====

When sampling features and ultimate features of interest are hosted on the same server, they are made accessible through sub-endpoints of the `DataStream` resource.

[requirement,model=ogc]
====
[%metadata]
identifier:: /req/datastream/sf-ref-from-datastream

conditions:: The server implements `http://www.opengis.net/spec/ogcapi-connectedsystems-1/1.0/req/sampling`

part:: The server SHALL implement a <<clause-sf-endpoint,Sampling Feature resources endpoint>> at path `{api_root}/datastreams/{dsId}/samplingFeatures` for each available `DataStream` resource.

part:: The endpoint SHALL only expose the `Sampling Feature` resources that are associated to observations in the parent `DataStream` with ID `dsId`.
====

[requirement,model=ogc]
====
[%metadata]
identifier:: /req/datastream/foi-ref-from-datastream

conditions:: 
  - The server provides the `featuresOfInterest` association as part of `DataStream` resource representations.
  - The server hosts the features of interest descriptions locally.

part:: The server SHALL implement a <<clause-features-endpoint,Feature resources endpoint>> at path `{api_root}/datastreams/{dsId}/featuresOfInterest` for each available `DataStream` resource.

part:: The endpoint SHALL only expose the `Feature` resources that are the ultimate features of interest of observations in the parent `DataStream` with ID `dsId`.
====



=== DataStream Canonical URL

The CS API Standard requires that every `DataStream` resource has a canonical URL.

include::../requirements/datastream/req_canonical_url.adoc[]



[[clause-datastream-resources-endpoint]]
=== DataStream Resources Endpoints

==== Definition

A `DataStream` {resources-endpoint} is an endpoint exposing a set of `DataStream` resources that can be further filtered using query parameters.

include::../requirements/datastream/req_resources_endpoint.adoc[]

<<clause-datastream-query-params>> defines additional query parameters applicable to `DataStream` resources endpoint.

[[clause-canonical-datastream-rep]]
==== Canonical DataStream Resources Endpoint

The CS API Standard requires that a canonical `DataStream` resources endpoint, exposing all `DataStream` resources, be made available by the server.

include::../requirements/datastream/req_canonical_endpoint.adoc[]

==== Nested DataStream Resources Endpoints

The set of datastreams produced by a specific system is available at a nested endpoint under the corresponding `System` resource:

[requirement,model=ogc]
====
[%metadata]
identifier:: /req/datastream/ref-from-system

conditions:: The server implements `http://www.opengis.net/spec/ogcapi-connectedsystems-1/1.0/req/system`

part:: The server SHALL implement a {datastream-resources-endpoint} at path `{api_root}/systems/{sysId}/datastreams` for each available `System` resource.

part:: The endpoint SHALL only expose the `DataStream` resources associated to the `System` with ID `sysId`.
====

The set of datastreams associated to a specific deployment is available at a nested endpoint under the corresponding `Deployment` resource:

[requirement,model=ogc]
====
[%metadata]
identifier:: /req/datastream/ref-from-deployment

conditions:: The server implements `http://www.opengis.net/spec/ogcapi-connectedsystems-1/1.0/req/deployment`

part:: The server SHALL implement a {datastream-resources-endpoint} at path `{api_root}/deployments/{depId}/datastreams` for each available `Deployment` resource.

part:: The endpoint SHALL only expose the `DataStream` resources associated to a system that was deployed during the `Deployment` with ID `depId`, and whose valid time intersects the deployment time period.
====



=== DataStream Collections

Any number of resources collections containing `DataStream` resources can be available at a CS API endpoint. `DataStream` collections are identified with the item type `DataStream`.

`DataStream` resources can be grouped into collections according to any arbitrary criteria, as exemplified below:

[example%unnumbered]
====
*Examples of DataStream Collections*

- All data collected by organization X at URL `{api_root}/collections/orgx_datastreams`
- All data collected during a field survey involving multiple sensors at URL `{api_root}/collections/campaignX_datastreams`

_Note that a given datastream can be part of multiple collections at the same time._
====

include::../requirements/datastream/req_collections.adoc[]



[[clause-observation-schemas]]
=== Observation Schemas

A different observation schema is needed for each individual datastream because the exact content of the observations result changes according to result type and the properties being observed. Moreover, multiple observation formats can be offered for any given datastream, and the schema is typically expressed differently for each format.

Thus, for each `DataStream` resource, the CS API provides a way for the server to communicate an observation schema (_not necessarily a JSON schema_) for each supported observation format. The exact content of a schema resource is defined by each encoding. See section <<clause-json-obsschema>> for example schemas used for observations encoded using the default JSON format.

Extensions to this Standard can define additional representation formats for observations. Such format extensions must clearly define the mapping between elements of the representation format and the <<clause-observation-resource,Observation resource>> defined in the next clause.

[requirement,model=ogc]
====
[%metadata]
identifier:: /req/datastream/schema-op

[.component,class=part]
--
For every `DataStream` resource exposed at the CS API endpoint, the server SHALL support the HTTP GET operation at the path `{api_root}/datastreams/{id}/schema`.
--

[.component,class=part]
--
The operation SHALL support the parameter `obsFormat` with the following characteristics (using an OpenAPI 3.0 fragment):

```yaml
include::../openapi/parameters/obsFormat.yaml[]
```
--

[.component,class=part]
--
A successful execution of the operation SHALL be reported as a response with a HTTP status code 200. The server SHALL return a single schema corresponding to the format identified by the `obsFormat` parameter.
--

[.component,class=part]
--
Error cases SHALL be reported using HTTP status codes listed in https://docs.ogc.org/is/17-069r4/17-069r4.html#http_status_codes[Clause 7.5.1] of {ogcapi-features-1}.
--
====

[example%unnumbered]
=================
*Example*

If a datastream with ID `{id}` reports the following supported observation formats:

- `application/json`
- `application/swe+csv`
- `application/swe+binary`

The schema for each of these formats is obtained with the following requests, respectively:

- `\https://{api_root}/datastreams/{id}/schema?obsFormat=application/json`
- `\https://{api_root}/datastreams/{id}/schema?obsFormat=application/swe%2Bcsv`
- `\https://{api_root}/datastreams/{id}/schema?obsFormat=application/swe%2Bbinary`

Note that the media type in the request has to be properly URL encoded, leading to the `%2B` in place of the `+` character.
=================



[[clause-observation-resource]]
=== Observation Resource

==== Introduction

In the CS API Standard, `Observation` resources are a special kind of resource that implements the _http://www.w3.org/ns/sosa/Observation[sosa:Observation]_ concept.

In the CS API, `Observation` resources are always associated to a `DataStream` (e.g., a type of https://www.w3.org/TR/vocab-ssn-ext/#sosa:ObservationCollection[_ObservationCollection_]). Some properties of the observation (e.g., link to the observing system, observed properties) can thus be omitted as they are provided at the datastream level.

In addition, the CS API does not restrict `Observation` resources to have a single observed property. It is thus possible to package the observation result of several properties in a single resource.

This section defines the attributes and associations composing a `Observation` resource, but the exact way they are encoded in the payload is defined by each encoding. For encodings defined in this document, please see:

- <<clause-json-observation,Observation resource encoded in JSON>>

Below is the contextual class diagram of the `Observation` resource:

[#observation-class,reftext='{figure-caption} {counter:figure-num}']
.Observation Resource Diagram
image::figures/FIG003-observation-class.png[api-class-diagram, align="center"]

==== Properties

The following tables describe the attributes and associations of an `Observation` resource and their mapping to SOSA/SSN.

[#observation-attributes,reftext='{table-caption} {counter:table-num}']
.Observation Attributes
[width="100%",options="header"]
|====
| *Name*              | *SOSA/SSN Property* | *Definition* | *Data Type* | *Usage*
| `phenomenonTime`    | `sosa:phenomenonTime` | The time the observed property value applies to the feature of interest. | DateTime | Required
| `resultTime`        | `sosa:resultTime` | The time the result value was obtained. | DateTime | Required
| `parameters`        | - | Observation parameters, providing information about how the procedure was used to produce this specific observation. | Any | Optional
| `result`            | `sosa:hasResult` | Observation result, carrying the estimated values of the observed properties. | Any | Required
|====

NOTE: The `phenomenonTime` can be in the far past (e.g., geological or deep space observations) or in the future (e.g., weather forecast). The `resultTime`, however, can never be in the future.

[#observation-assocs,reftext='{table-caption} {counter:table-num}']
.Observation Associations
[width="100%",options="header"]
|====
| *Name*             | *SOSA/SSN Property* | *Definition* | *Target Content* | *Usage*
| `datastream`       | - | The `DataStream` that the observation is part of. | A single `DataStream` resource. | Required
| `samplingFeature`  | `sosa:hasFeatureOfInterest` | The sampling feature that is the subject of the observation. | A single `SamplingFeature` resource. | Optional
| `procedure`        | `sosa:usedProcedure` | The procedure that was used to make the observation | A single `Procedure` resource. | Optional
|====



=== Observation Canonical URL

The CS API Standard requires that every `Observation` resource has a canonical URL.

include::../requirements/datastream/observation/req_canonical_url.adoc[]



[[clause-observation-resources-endpoint]]
=== Observation Resources Endpoint

==== Definition

An `Observation` {resources-endpoint} is an endpoint exposing a set of `Observation` resources that can be further filtered using query parameters.

include::../requirements/datastream/observation/req_resources_endpoint.adoc[]

[[clause-observations-endpoint]]
==== Canonical Observation Resources Endpoint

The CS API Standard requires that a canonical `Observation` resources endpoint, exposing all `Observation` resources, be made available by the server.

include::../requirements/datastream/observation/req_canonical_endpoint.adoc[]

==== Nested Observation Resources Endpoint

The set of observations produced as part of a specific datastream is available at a nested endpoint under the corresponding `DataStream` resource:

[requirement,model=ogc]
====
[%metadata]
identifier:: /req/datastream/obs-ref-from-datastream

part:: The server SHALL implement a <<clause-observations-endpoint,Observation resources endpoint>> at path `{api_root}/datastreams/{dsId}/observations` for each available `DataStream` resource.

part:: The endpoint SHALL only expose the `Observation` resources that are part of the parent `DataStream` with ID `dsId`.
====


=== Observation Collections

Any number of resources collections containing `Observation` resources can be available at a CS API endpoint. `Observation` collections are identified with the item type `Observation`.

`Observation` resources can be grouped into collections according to any arbitrary criteria, as exemplified below:

[example%unnumbered]
====
*Examples of Observation Collections*

- All observations collected by organization X at URL `{api_root}/collections/orgx_obs`
- All observations collected during a field survey involving multiple sensors at URL `{api_root}/collections/campaignX_obs`

_Note that a given observation can be part of multiple collections at the same time._
====

include::../requirements/datastream/observation/req_collections.adoc[]
